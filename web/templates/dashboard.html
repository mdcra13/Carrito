<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Carrito</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1 class="titulo-principal">ðŸš— Panel del Carrito Seguidor de Luz</h1>

    <section class="estado-actual">
        <h2>ðŸ“¡ Ãšltimo estado del Carrito</h2>

        <div class="card-estado">
            <div class="fila">
                <span class="titulo">Ãšltima AcciÃ³n:</span>
                <span id="accion" class="valor">â€”</span>
            </div>

            <div class="fila">
                <span class="titulo">PredicciÃ³n:</span>
                <span id="prediccion" class="valor">â€”</span>
            </div>

            <div class="fila">
                <span class="titulo">Sensor Izquierdo (L):</span>
                <span id="sensorL" class="valor">â€”</span>
            </div>

            <div class="fila">
                <span class="titulo">Sensor Derecho (R):</span>
                <span id="sensorR" class="valor">â€”</span>
            </div>

            <div class="fila">
                <span class="titulo">Ãšltima actualizaciÃ³n:</span>
                <span id="fecha" class="valor">â€”</span>
            </div>
        </div>
    </section>


    <section class="historial">
        <h2>ðŸ“œ Historial Reciente</h2>

        <table class="tabla-historial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>AcciÃ³n</th>
                    <th>PredicciÃ³n</th>
                    <th>Sensor L</th>
                    <th>Sensor R</th>
                </tr>
            </thead>
            <tbody id="tabla-datos">
            </tbody>
        </table>
    </section>

    <section class="grafico">
        <h2>ðŸ“ˆ GrÃ¡fico de los sensores</h2>

        <div class="grafico-container">
            <canvas id="graficoLuz"></canvas>
        </div>
    </section>


<script>
    let chart;
    let labels = [];
    let dataL = [];
    let dataR = [];

    function ajustarResolucionCanvas() {
        const canvas = document.getElementById('graficoLuz');
        const parent = canvas.parentElement;

        const width = parent.clientWidth;
        const height = parent.clientHeight;
        const pixelRatio = window.devicePixelRatio || 1;

        canvas.width = width * pixelRatio;
        canvas.height = height * pixelRatio;

        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
    }

    function crearGrafico() {
        ajustarResolucionCanvas();

        const ctx = document.getElementById("graficoLuz").getContext("2d");

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Sensor Izquierdo (L)",
                        data: dataL,
                        borderWidth: 2
                    },
                    {
                        label: "Sensor Derecho (R)",
                        data: dataR,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
            }
        });
    }

    function actualizarGrafico() {
        if (!chart) {
            crearGrafico();
        } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = dataL;
            chart.data.datasets[1].data = dataR;
            chart.update();
        }
    }

    async function cargarDatos() {
        const res = await fetch("/api/datos");
        const datos = await res.json();
        if (datos.length === 0) return;

        const ultimo = datos[0];
        document.getElementById("accion").innerText = ultimo.accion;
        document.getElementById("prediccion").innerText = ultimo.prediccion;
        document.getElementById("sensorL").innerText = ultimo.sensor_izq;
        document.getElementById("sensorR").innerText = ultimo.sensor_der;
        document.getElementById("fecha").innerText = ultimo.fecha;

        const tabla = document.getElementById("tabla-datos");
        tabla.innerHTML = "";

        datos.forEach(d => {
            tabla.innerHTML += `
                <tr>
                    <td>${d.fecha}</td>
                    <td>${d.accion}</td>
                    <td>${d.prediccion}</td>
                    <td>${d.sensor_izq}</td>
                    <td>${d.sensor_der}</td>
                </tr>
            `;
        });

        labels = datos.map(d => d.fecha).reverse();
        dataL = datos.map(d => d.sensor_izq).reverse();
        dataR = datos.map(d => d.sensor_der).reverse();

        actualizarGrafico();
    }

    cargarDatos();
    setInterval(cargarDatos, 3000);
</script>

</body>
</html>