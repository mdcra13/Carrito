<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Carrito</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1 class="titulo-principal">üöó Panel del Carrito Seguidor de Luz</h1>

    <!-- üî• Carrito animado seg√∫n acci√≥n -->
    <div id="carrito" class="carrito-animado">üõí</div>

    <!-- Estado Actual -->
    <section class="estado-actual">
        <h2>üì° √öltimo estado del Carrito</h2>

        <div class="card-estado">
            <div class="fila">
                <span class="titulo">√öltima Acci√≥n:</span>
                <span id="accion" class="valor">‚Äî</span>
            </div>

            <div class="fila">
                <span class="titulo">Predicci√≥n:</span>
                <span id="prediccion" class="valor">‚Äî</span>
            </div>

            <div class="fila">
                <span class="titulo">Sensor Izquierdo (L):</span>
                <span id="sensorL" class="valor">‚Äî</span>
            </div>

            <div class="fila">
                <span class="titulo">Sensor Derecho (R):</span>
                <span id="sensorR" class="valor">‚Äî</span>
            </div>

            <div class="fila">
                <span class="titulo">√öltima actualizaci√≥n:</span>
                <span id="fecha" class="valor">‚Äî</span>
            </div>
        </div>
    </section>

    <!-- Historial -->
    <section class="historial">
        <h2>üìú Historial Reciente</h2>

        <table class="tabla-historial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Acci√≥n</th>
                    <th>Predicci√≥n</th>
                    <th>Sensor L</th>
                    <th>Sensor R</th>
                </tr>
            </thead>
            <tbody id="tabla-datos"></tbody>
        </table>
    </section>

    <!-- Gr√°fico -->
    <section class="grafico">
        <h2>üìà Gr√°fico de los sensores</h2>

        <div class="grafico-container">
            <canvas id="graficoLuz"></canvas>
        </div>
    </section>

    <!-- üî• MAPA DEL RECORRIDO DEL CARRITO -->
    <section class="mapa-ruta">
        <h2>üó∫Ô∏è Recorrido del Carrito</h2>

        <div class="mapa-container">
            <canvas id="mapaCarrito" width="800" height="300"></canvas>
        </div>
    </section>

<script>
    let chart;
    let labels = [];
    let dataL = [];
    let dataR = [];

    function ajustarResolucionCanvas() {
        const canvas = document.getElementById('graficoLuz');
        const parent = canvas.parentElement;

        const width = parent.clientWidth;
        const height = parent.clientHeight;
        const pixelRatio = window.devicePixelRatio || 1;

        canvas.width = width * pixelRatio;
        canvas.height = height * pixelRatio;

        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
    }

    function crearGrafico() {
        ajustarResolucionCanvas();
        const ctx = document.getElementById("graficoLuz").getContext("2d");

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Sensor Izquierdo (L)",
                        data: dataL,
                        borderWidth: 2
                    },
                    {
                        label: "Sensor Derecho (R)",
                        data: dataR,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
            }
        });
    }

    function actualizarGrafico() {
        if (!chart) {
            crearGrafico();
        } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = dataL;
            chart.data.datasets[1].data = dataR;
            chart.update();
        }
    }

    // ====== MAPA DEL CARRITO ======
    const canvasMapa = document.getElementById("mapaCarrito");
    const ctxMapa = canvasMapa.getContext("2d");

    let x = 400;
    let y = 150;

    function dibujarCarritoMapa() {
        ctxMapa.clearRect(0, 0, canvasMapa.width, canvasMapa.height);

        ctxMapa.beginPath();
        ctxMapa.arc(x, y, 5, 0, Math.PI * 2);
        ctxMapa.fillStyle = "#a300a3";
        ctxMapa.fill();
        ctxMapa.closePath();

        ctxMapa.fillStyle = "#ff33cc";
        ctxMapa.fillRect(x - 10, y - 10, 20, 20);

        ctxMapa.strokeStyle = "#660066";
        ctxMapa.strokeRect(x - 10, y - 10, 20, 20);
    }

    function moverCarritoSegunAccion(accion) {
        const step = 10;

        if (accion === "avanzar") y -= step;
        if (accion === "atras") y += step;
        if (accion === "izquierda" || accion === "girar_izquierda") x -= step;
        if (accion === "derecha" || accion === "girar_derecha") x += step;

        if (x < 10) x = 10;
        if (x > canvasMapa.width - 10) x = canvasMapa.width - 10;
        if (y < 10) y = 10;
        if (y > canvasMapa.height - 10) y = canvasMapa.height - 10;

        dibujarCarritoMapa();
    }

    // Funci√≥n principal de carga de datos
    async function cargarDatos() {
        const res = await fetch("/api/datos");
        const datos = await res.json();
        if (datos.length === 0) return;

        const ultimo = datos[0];

        document.getElementById("accion").innerText = ultimo.accion;
        document.getElementById("prediccion").innerText = ultimo.prediccion;
        document.getElementById("sensorL").innerText = ultimo.sensor_izq;
        document.getElementById("sensorR").innerText = ultimo.sensor_der;
        document.getElementById("fecha").innerText = ultimo.fecha;

        const tabla = document.getElementById("tabla-datos");
        tabla.innerHTML = "";
        datos.forEach(d => {
            tabla.innerHTML += `
                <tr>
                    <td>${d.fecha}</td>
                    <td>${d.accion}</td>
                    <td>${d.prediccion}</td>
                    <td>${d.sensor_izq}</td>
                    <td>${d.sensor_der}</td>
                </tr>`;
        });

        labels = datos.map(d => d.fecha).reverse();
        dataL = datos.map(d => d.sensor_izq).reverse();
        dataR = datos.map(d => d.sensor_der).reverse();

        actualizarGrafico();

        moverCarritoSegunAccion(ultimo.accion);
    }

    dibujarCarritoMapa();
    cargarDatos();
    setInterval(cargarDatos, 3000);
</script>

</body>
</html>
